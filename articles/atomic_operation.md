---
title: "【Flutter×Firestore】一括で読み込み・書き込みをする方法" # 記事のタイトル
emoji: "🔥" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["firebase","flutter","firestore"] # タグ。["markdown", "rust", "aws"]のように指定する
published: false # 公開設定（falseにすると下書き）
---


# 一括処理（アトミックオペレーション）とは

[公式ドキュメント](https://firebase.google.com/docs/firestore/manage-data/transactions?hl=ja)では
> Cloud Firestore は、データを読み書きするアトミック オペレーションをサポートしています。一連のアトミック オペレーションでは、すべてのオペレーションが正常に完了するか、またはどのオペレーションも適用されないかのいずれかです。

と説明されています。

つまりアトミックオペレーションとは、
- いくつかの処理をセットにし、
- その処理群のいずれかが失敗した場合は全部なかったことにする。

という読み込み・書き込み方法を指します。

Firestoreでは

1. トランザクション
2. バッチ書き込み

の2つのアトミックオペレーションが用意されています。
トランザクションは 読み取り / 書き込み の両方を一括で処理でき、
バッチ書き込みは 書き込み を一括で処理できます。
アトミックオペレーションのメリットとしては

- 書き込み数を減らすことができる
- どれかがコケたら全部ナシにしたい、という場面で有効

などが挙げられます。

# トランザクションとバッチ書き込みの違い

主は違いは

- 読み取りができるか、できないか
- データの整合性が担保されているか、されていないか

です。

トランザクションは、一括処理の中に読み取り（get）メソッドと書き込み（set, add, update, delete）の両方を含めることができますが、
バッチ書き込みでは、その名のとおり、一括処理の中に含めることができるのは、書き込み（set, add, update, delete）メソッドのみとなり、読み取りメソッドは含めることができません。

「じゃあ全部トランザクションで書いたらいいじゃん」と思われるかもしれませんが、それぞれのメリット・デメリットが存在するので、それらを把握した上で使い分けを判断する必要があります。

前置きが長くなってしまいましたが、トランザクションとバッチ書き込みの具体例をみていきましょう。



# 1.トランザクション

トランザクションは、1 つ以上のドキュメントに対して読み取り / 書き込みを行う一連のオペレーションです。

## Flutterでの書き方

- 例：Twitterでフォローボタンを押したとき

```dart
  final db = FirebaseFirestore.instance;


```

## 注意点

- 読み取りオペレーション（get）は、書き込みオペレーション（add, set, update, delete)の前に実行する必要がある
- クライアントがオフラインの場合、トランザクションは失敗します。


# 2.バッチ書き込み

バッチ書き込みは、1 つ以上のドキュメントに対して書き込みを行う一連のオペレーションです。

（例）お気に入り登録

# 制約事項

トランザクションとバッチ書き込みにおいては、以下の制約がある点に注意が必要です
- 1回のアトミックオペレーション（一括処理）に登録できる処理は500個まで


# アトミックオペレーションに関するデータの検証




# 参考

- Firebase公式

https://firebase.google.com/docs/firestore/manage-data/transactions?hl=ja

